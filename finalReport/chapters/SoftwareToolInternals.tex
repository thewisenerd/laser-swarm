\section{Software Tool Internals}
\label{SoftwareToolInternals}

In the software tool, the constellation is simulated, and the inverse problems of the altitude and BRDF determination are solved. For the simulation of the constellation, the satellites were given a set of parameters. Furthermore, every satellite has a set of Keplerian elements which provide the orbit. 

For the main emitter satellite there are a few other parameters describing the laser behavior. These are the laser wavelength, the beam divergence, the pulse time and the power. The power is the actual lasing power of the laser, so not the input electrical power of the laser. Note that the laser is perpetually nadir-pointing.

For the receiving satellites, the receiver is characterized by the receiver spectral filter width, the aperture area, the receiver beam divergence (which determines the footprint) and the receiver efficiency. The receiver efficiency is composed out of the optical efficiency ($\sim0.9$) and receiver chip efficiency ($\sim0.34$). Note the receiver is assumed to be perfectly pointed to the emitter footprint. Also, the footprint of the receiver is larger than the footprint of the emitter.

The basic path of the signal is that it is transmitted, then propagates downwards through the atmosphere to the earth. There it scatters back in all directions. If there is sunlight shining on the footprint, that is also scattered upwards. In the direction of each receiving satellite, a small cone of the reflected energy is scattered. This again propagates through the atmosphere and is then received by the receivers. The internals of the simulation steps will be discussed more closely in the following sections.

\subsection{Signal Emmission}
As mentioned before, the signal is emitted at the position of the emitter satellite. The power in each pulse can be determined by spreading the continuous lasing power of the laser over its duty cycle:

\begin{equation}
	P_{pulsed} =  \frac{P_{continues}}{pulse length \times pulse frequency}
\end{equation}

This means that the power in each pulse is high compared to the continuous lasing power. The pulse is directed towards the satellite nadir. This means that when the signal travels trough the atmosphere it encounters an airmass of exactly one.

\subsection{Atmospheric effects}

When a signal travels through the atmosphere, it is modified in several ways. Of these modifications, the largest effect is the atmospheric attenuation of the signal. This is also the only type of atmospheric effect that is taken into account.

The atmospheric attenuation is dependent on both optical trickiness of the atmosphere and airmass (path length through the atmosphere). The airmass factor and can be found using equation \ref{eq:airmass}. The optical thickness is dependent on the laser frequency and can be found in tables (for 473nm this is about 10\%). The attenuation of the signal can then be computed with equation \ref{eq:AtmAttenuation}.

\begin{equation}
	l = sec (z)
	\label{eq:airmass}
\end{equation}
\begin{equation}
	I = I_0 \: e^{ -optThick \cdot l }
	\label{eq:AtmAttenuation}
\end{equation}

In equation \ref{eq:airmass}, z is the zenith angle (angle between the satellite direction and up direction on the earth). Note this equation is only valid when the satellite is not near the horizon as there this formula breaks down. But due to the maximum angular separation of 2.18$^\circ$ this situation is not encountered.

\subsection{Scattering}
\subsubsection{Laser Scattering}
\label{scatter}
When the laser pulse reaches the ground it is scattered back. The scattering model used to describe this is taken from the discussion thereon in \cite{rees}. 

Scatter is the physical process where incident radiation is absorbed and reflected back towards the atmosphere. To this end a scattering model is used. This scattering model is a way to construct a \ac{BRDF}. A \ac{BRDF} is a distribution of the incident light over the hemisphere \cite[pages 47-49]{rees}. An example is shown in figure \ref{fig:scatter}, page \pageref{fig:scatter}.\\\\
The most basic example of a \ac{BRDF} is the Lambertian model \cite[pages 49-50]{rees}. This model assumes a homogeneous perfectly rough surface, causing a homogeneous scattering distribution. Apart from the index of refraction of the air, the incident radiation vector and the exittant radiation vector (which are all known), use of Snell's law is needed to find Fresnel's coefficients, thereby requiring the index of refraction of the ground.

A modification that can be made to take into account the tendency of surfaces to scatter more in the direction of the surface normal, is called the Minnaert model \cite[page 50]{rees}. It causes a more elliptical \ac{BRDF}. It depends on the Minnaert parameter $\kappa$.

Another important modification is the Henyey-Greenstein term. It accounts for the tendency of surfaces to back- or forwardscatter \cite[page 51]{rees}. This rotates and deforms the elliptical \ac{BRDF} obtained from the Minnaert model. The Henyey-Greenstein term is parameterized by $\Theta$. The final result is shown in figure \ref{fig:scatter}, page \pageref{fig:scatter}.\\\\
This is the scattering model used in the program. Because there is no data from which all three parameters can be accurately determined, a coefficient map was made up. It does not matter much what the precise form of the \ac{BRDF} used in the simulation is, so long as it can be retrieved.

With the help of the formulae from \cite[pages 43-51]{rees}, the incidence vector can be taken and the number of photons radiated in a specific direction can be calculated. This is done by the same algorithms both for laser photons a for sun noise.

\begin{figure}[ht!]
\centering
\includegraphics[width=0.4\textwidth]{chapters/img/scatter.png}
\caption{Example of a \ac{BRDF}}
\label{fig:scatter}
\end{figure}

\subsubsection{Noise Scattering}

Also noise is reflected up to the satellites. This reflection takes place in the receiver footprint. Because the direction of the receiver is not perpendicular to the normal of the reflection area, the footprint becomes elliptical. Over this entire elliptical area, solar radiation is reflected to the receiver.

The amount of solar flux that is reflected up to the satellites is only the flux in the spectral width of the receiver. Then using the laws of gray body radiation, the amount of solar flux in the given spectrum is computed that hits the receiver footprint. The equation used to compute the influx is:

\begin{equation}
	\lambda_{1,2} = \lambda _{laser} \pm \frac{Wavelength Bandwidth}{2}
\end{equation}
\begin{equation}
	I = \sigma T^4 (f(\lambda _1, T, \epsilon) - f(\lambda _1, T, \epsilon))
\end{equation}

In this equation f(x) is an approximation of Planck's Integral \cite[p.~26]{rees}. This flux is then scatted in the same manner as for the laser scattering, to all the receivers. The big difference is that this is a continuous process with respect to the laser, which happens in discrete steps.

\subsection{Reception by the receiver}

When the the energy of the laser pule and the noise, reach the receiver again, the amount of received photons can be determined. This is done based on the energy per photon, which is defined in equation \ref{eq:PhotonEnergy}. Then the total number of received photons is equal to the inbound energy divided by the energy per photon. The floating remainder is then compared to a random generated number from zero to one, and if the random number is smaller then the remainder, an extra photon is added.

\begin{equation}
	E_{p}=\frac{h \cdot c}{\lambda}
	\label{eq:PhotonEnergy}
\end{equation}

In equation \ref{eq:PhotonEnergy}, h is the Planck constant, c the speed of light and $\lambda$ the wavelength of the emitter laser (473 nm).
